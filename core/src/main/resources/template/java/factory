package #{$package};

import com.teamide.*;
import com.teamide.factory.*;
import com.teamide.bean.*;
import com.teamide.dao.IDao;
import com.teamide.exception.*;
import com.teamide.factory.DatabaseFactory;
import com.teamide.jexl.JexlProcessor;
import com.teamide.jexl.SqlJexlResolver;
import com.teamide.service.IService;
import com.teamide.util.LogUtil;

import java.util.Map;

import org.apache.commons.jexl3.JexlException;
import org.slf4j.Logger;

import com.alibaba.fastjson.*;
#ifStart($usespringannotation == true)#
import org.springframework.stereotype.Component;
#ifEnd#

/**
 * AppFactory
 * 应用工厂
 */
@SuppressWarnings("unused")
#ifStart($usespringannotation == true)#
@Component("teamide-factory")
#ifEnd#
public class #{$classname} extends BaseFactory{
	
	static Logger logger = LogUtil.get();
	
	static final #{$classname} TEAMIDE_FACTORY = new #{$classname}();
	
	/**
	 * 实例化数据库工厂类，传入默认jdbc，和数据库配置目录，配置目录可以通过文件名直接访问
	 */
	public DatabaseFactory createDatabaseFactory() {
		return new DatabaseFactory("jdbc", "databases");
	}

	/**
	 * 获取默认jdbc实例化的Dao，可以传入data，根据data属性值实现动态数据源
	 */
	public static IDao getDao(JSONObject data) throws Exception {

		return TEAMIDE_FACTORY.newDao(data);
	}

	/**
	 * 获取默认jdbc实例化的Service，可以传入data，根据data属性值实现动态数据源
	 */
	public static IService getService(JSONObject data) throws Exception {

		return TEAMIDE_FACTORY.newService(data);
	}
	
	#forStart($databases, $database)#
	public static IDao getDaoFor#{$database.name}(JSONObject data) throws Exception {

		return TEAMIDE_FACTORY.newDao("#{$database.name}", data);
	}

	public static IService getServiceFor#{$database.name}(JSONObject data) throws Exception {

		return TEAMIDE_FACTORY.newService("#{$database.name}", data);
	}
	#forEnd#


	/**
	 * jexl表达式处理器，解析字符表达式，得到结果
	 */
	public static JexlProcessor JEXL_PROCESSOR = new JexlProcessor();

	/**
	 * 传入表达式和data，获取表达式值
	 * 
	 * @param jexlScript
	 *            表达式
	 * @param data
	 *            数据
	 * @return 表达式解析结果
	 */
	public static Object getValueByJexlScript(String jexlScript, JSONObject data) {

		try {
			return JEXL_PROCESSOR.invoke(jexlScript, data);
		} catch (JexlException.Variable e) {
			logger.warn(e.getMessage());
		}
		return null;
	}

	/**
	 * 解析sql表达式，sql可以使用#{key} ，:#{key}动态去data中取值
	 * 
	 * @param sql
	 *            含有表达式的sql
	 * @param param
	 *            sql的参数，解析出来的表达式值，填充到这个map中
	 * @param data
	 *            数据对象，从这个对象中取值
	 * @return 返回解析后的sql，将#{key}转为 value，将:#{key}转换为:key占位符
	 */
	public static String resolveSqlJexl(String sql, Map<String, Object> param, JSONObject data) {
		// 只解析含有表达式的SQL
		if (sql != null && sql.indexOf("#{") >= 0) {
			SqlJexlResolver sqlJexlResolver = new SqlJexlResolver(sql, data, JEXL_PROCESSOR);
			sql = sqlJexlResolver.resolve();
			for (String key : sqlJexlResolver.getParam().keySet()) {
				param.put(key, sqlJexlResolver.getParam().get(key));
			}
		}
		return sql;
	}
	
	
	/**
	 * 将结果转成status
	 * 
	 * @param result
	 *            结果
	 * @return status 转后的返回
	 */
	public static Object toStatus(Object result, Exception e) {
		if (e != null) {
			Status error = Status.FAIL();
			error.setErrmsg(e.getMessage());
			if (e instanceof BaseException) {
				BaseException base = (BaseException) e;
				error.setErrcode(base.getErrcode());
				error.setErrmsg(base.getErrmsg());
			} else if (e instanceof NullPointerException) {
				error.setErrmsg("null pointer exception.");
				e.printStackTrace();
			}
			return error;
		}
		Status status = Status.SUCCESS();
		if (result != null) {
			if (!(result instanceof ResultBean)) {
				status.setValue(result);
			} else {
				return result;
			}
		}
		return status;
	}

}