package #{$package};

import java.util.*;
import com.teamide.util.*;
import com.teamide.exception.*;

import com.alibaba.fastjson.*;

import #{$app_factory.$package}.#{$app_factory.$classname};

import com.teamide.db.bean.*;
#ifStart($sqlType == 'SELECT_PAGE')#
import com.teamide.bean.PageResultBean;
#ifEnd#
#ifStart($sqlType != 'SELECT_PAGE')#
#ifEnd#

import com.teamide.dao.IDao;
import com.teamide.param.DataParam;
import com.teamide.annotation.*;

#ifStart($usespringannotation == true)#
import org.springframework.stereotype.Service;
import org.springframework.beans.factory.annotation.Autowired;
#ifEnd#

/**
 * SQL Dao 查询
 * #{$comment}
 */
@SuppressWarnings("unused")
#ifStart($usespringannotation == true)#
@Service
#ifEnd#
public class #{$classname} {

	#ifStart($usespringannotation == true)#
	@Autowired
	#{$app_factory.$classname} factory;
	#ifEnd#
	#ifStart($usespringannotation == false)#
	#{$app_factory.$classname} factory = #{$app_factory.$classname}.TEAMIDE_FACTORY;
	#ifEnd#

	/**
	 * 执行
	 */
	#ifStart($usespringannotation == true)#
	@DataSource()
	#ifEnd#
	#ifStart($sqlType == 'SELECT_ONE')#
	public Map<String, Object> invoke(@VariableData JSONObject data) throws Exception {
	#ifEnd#
	#ifStart($sqlType == 'SELECT_LIST')#
	public List<Map<String, Object>> invoke(@VariableData JSONObject data) throws Exception {
	#ifEnd#
	#ifStart($sqlType == 'SELECT_PAGE')#
	public PageResultBean<Map<String, Object>> invoke(@VariableData JSONObject data) throws Exception {
	#ifEnd#
		
		#ifStart($database == null)#
		IDao dao = factory.getThreadLocalDao(data);
		#ifEnd#
		#ifStart($database != null)#
		IDao dao = factory.getThreadLocalDao("#{$database.name}", data);
		#ifEnd#
		
		// 组合SQL Param
		#ifStart($sqlType == 'SELECT_ONE')#
		SqlParam sqlParam = buildSqlParam(data);
		Map<String, Object> result = dao.queryOne(sqlParam);
		#ifEnd#
		#ifStart($sqlType == 'SELECT_LIST')#
		SqlParam sqlParam = buildSqlParam(data);
		List<Map<String, Object>> result = dao.queryList(sqlParam);
		#ifEnd#
		#ifStart($sqlType == 'SELECT_PAGE')#
		PageSqlParam pageSqlParam = buildSqlParam(data);
		PageResultBean<Map<String, Object>> result = dao.queryPage(pageSqlParam);
		#ifEnd#
		format(result, data);
		return result;
	}
	
	/**
	 * 组合SQL
	 */
	#ifStart($sqlType == 'SELECT_PAGE')#
	public PageSqlParam buildSqlParam(JSONObject data) throws Exception {
	#ifEnd#
	#ifStart($sqlType != 'SELECT_PAGE')#
	public SqlParam buildSqlParam(JSONObject data) throws Exception {
	#ifEnd#
		// 用于暂存字段取到的值
		Object value = null;
		// SQL执行用到的参数，SQL中使用“:key”作占位符
		Map<String, Object> param = new HashMap<String, Object>();
		
		// SQL语句
		StringBuffer sql = new StringBuffer();
		// SQL From语句
		StringBuffer fromSql = new StringBuffer();
		// SQL Where语句
		StringBuffer whereSql = new StringBuffer();
		// SQL Group语句
		StringBuffer groupSql = new StringBuffer();
		// SQL 追加语句
		StringBuffer appendSql = new StringBuffer();
		
#{$content}

		// 拼接追加SQL语句
		sql.append(" ").append(appendSql);
		#ifStart($sqlType == 'SELECT_PAGE')#
		// 统计语句，用于分页
		StringBuffer countSql = new StringBuffer("SELECT COUNT(1) ");
		
		// 拼接查询From语句条件
		countSql.append(fromSql);
		// 拼接统计语句条件
		countSql.append(whereSql);
		// 拼接统计语句条件
		countSql.append(groupSql);
		
		// 解析SQL表达式，获得真实SQL
		String realSql = #{$app_factory.$classname}.resolveSqlJexl(sql.toString(), param, data);
		String realCountSql = #{$app_factory.$classname}.resolveSqlJexl(countSql.toString(), param, data);
		PageSqlParam pageSqlParam = new PageSqlParam(realSql, realCountSql, param);
		// 获取页码和每页数量
		int pagesize = data.getIntValue("_pagesize");
		int pageindex = data.getIntValue("_pageindex");
		pageSqlParam.setPagesize(pagesize);
		pageSqlParam.setPageindex(pageindex);
		
		return pageSqlParam;
		#ifEnd#
		#ifStart($sqlType != 'SELECT_PAGE')#
		// 解析SQL表达式，获得真实SQL
		String realSql = #{$app_factory.$classname}.resolveSqlJexl(sql.toString(), param, data);
		SqlParam sqlParam = new SqlParam(realSql, param);
		return sqlParam;
		#ifEnd#
	}
	
	#ifStart($sqlType == 'SELECT_PAGE')#
	/**
	 * 格式化分页结果
	 */
	public void format(PageResultBean<Map<String, Object>> result, JSONObject data) throws Exception {
		if(result == null) {
			return;
		}
		for(Map<String, Object> one : result.getValue()){
			format(one, data);
		}
	}
	#ifEnd#
	#ifStart($sqlType == 'SELECT_LIST')#
	/**
	 * 格式化列表结果
	 */
	public void format(List<Map<String, Object>> result, JSONObject data) throws Exception {
		if(result == null) {
			return;
		}
		for(Map<String, Object> one : result){
			format(one, data);
		}
	}
	#ifEnd#
	
	/**
	 * 格式化单条结果
	 */
	public void format(Map<String, Object> result, @VariableData JSONObject data) throws Exception {
		if(result == null) {
			return;
		}
		#forStart($subselects, $subselect, $index)#
		JSONObject json = new JSONObject();
		if(data != null){
			json.putAll(data);
		}
		json.putAll(result);
		result.put("#{$subselect.$name}", query#{$subselect.$method}(json));
		#forEnd#
	}
	
	#forStart($subselects, $subselect, $index)#
	/**
	 * 子查询
	 */
	@DataSource()
	public Object query#{$subselect.$method}(@VariableData JSONObject data) throws Exception {
		
		#ifStart($subselect.$database == null)#
		IDao dao = factory.getThreadLocalDao(data);
		#ifEnd#
		#ifStart($subselect.$database != null)#
		IDao dao = factory.getThreadLocalDao("#{$database.name}", data);
		#ifEnd#
		
		// 用于暂存字段取到的值
		Object value = null;
		// SQL执行用到的参数，SQL中使用“:key”作占位符
		Map<String, Object> param = new HashMap<String, Object>();
		
		// SQL语句
		StringBuffer sql = new StringBuffer();
		// SQL From语句
		StringBuffer fromSql = new StringBuffer();
		// SQL Where语句
		StringBuffer whereSql = new StringBuffer();
		// SQL Group语句
		StringBuffer groupSql = new StringBuffer();
		// SQL 追加语句
		StringBuffer appendSql = new StringBuffer();
		
#{$subselect.$content}

		// 拼接追加SQL语句
		sql.append(" ").append(appendSql);
		
		// 解析SQL表达式，获得真实SQL
		String realSql = #{$app_factory.$classname}.resolveSqlJexl(sql.toString(), param, data);
		
		#ifStart($subselect.queryone == true)#
		return dao.queryOne(new SqlParam(realSql, param));
		#ifEnd#
		#ifStart($subselect.queryone == false)#
		return dao.queryList(new SqlParam(realSql, param));
		#ifEnd#
	}
	#forEnd#
}