package #{$package};

#ifStart($usespringannotation == false)#
import java.io.IOException;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;

import com.teamide.util.ResponseUtil;
#ifEnd#
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.alibaba.fastjson.JSONObject;
import com.teamide.bean.ResultBean;
import com.teamide.bean.Status;
import com.teamide.client.ClientHandler;
import com.teamide.client.ClientSession;
import com.teamide.exception.BaseException;
import com.teamide.param.DataParam;

#ifStart($usespringannotation == true)#
import org.springframework.stereotype.Controller;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
#ifEnd#

#forStart($imports, $import)#
import #{$import};
#forEnd#

import #{$dao.$package}.#{$dao.$classname};

#ifStart($usespringannotation == true)#
@Controller
public class #{$classname} {
#ifEnd#
#ifStart($usespringannotation == false)#
@WebServlet(urlPatterns = "#{$requestmapping}")
public class #{$classname} extends HttpServlet {

	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;
#ifEnd#
	
	//#{$dao.$comment}
	#ifStart($usespringannotation == true)#
	@Autowired
	#{$dao.$classname} #{$dao.$propertyname};
	#ifEnd#
	#ifStart($usespringannotation == false)#
	#{$dao.$classname} #{$dao.$propertyname} = new #{$dao.$classname}();
	#ifEnd#

	#ifStart($usespringannotation == false)#
	@Override
	protected void service(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {
		invoke(request, response);
	}
	#ifEnd#
	
	#ifStart($usespringannotation == true)#
	#ifStart($dao.$requestmethod == null)#
	@RequestMapping("#{$requestmapping}")
	#ifEnd#
	#ifStart($dao.$requestmethod != null)#
	@RequestMapping(path = "#{$requestmapping}", method = { RequestMethod.#{$dao.$requestmethod }})
	#ifEnd#
	@ResponseBody
	public Object invoke(HttpServletRequest request, HttpServletResponse response) {
	#ifEnd#
	#ifStart($usespringannotation == false)#
	public void invoke(HttpServletRequest request, HttpServletResponse response) {
	#ifEnd#
		Object result = null;
		try {
			ClientSession session = ClientHandler.getSession(request);
			DataParam param = new DataParam(request, session);

			JSONObject data = new JSONObject();
			if (param.getData() != null) {
				data = (JSONObject) param.getData();
			}
			JSONObject variableCache = param.toVariableCache(data);
			
			#ifStart($dao.$is_batch == true)#
			result = #{$dao.$propertyname}.invoke(data, variableCache);
			#ifEnd#
			#ifStart($dao.$is_batch != true)#
			result = #{$dao.$propertyname}.invoke(variableCache);
			#ifEnd#
		} catch (Exception e) {
			Status error = Status.FAIL();
			error.setErrmsg(e.getMessage());
			if (e instanceof BaseException) {
				BaseException base = (BaseException) e;
				error.setErrcode(base.getErrcode());
				error.setErrmsg(base.getErrmsg());
			}
			result = error;
		}

		if (result == null) {
			result = Status.SUCCESS();
		}
		if (!(result instanceof ResultBean)) {
			Status status = Status.SUCCESS();
			status.setValue(result);
			result = status;
		}
		#ifStart($usespringannotation == true)#
		return result;
		#ifEnd#
		#ifStart($usespringannotation == false)#
		ResponseUtil.outJSON(response, result);
		#ifEnd#
	}

}
